# ADR-0005 1エージェント複数定例会議の紐付け対応

## ステータス

Proposed

## 経緯

現在のシステムでは、DBスキーマ上は1つのエージェントに対して複数の定例MTGを紐付けることが可能な設計（`recurring_meetings.agent_id`がFKとして設計）となっているが、アプリケーション層の実装は1対1を前提としている。

具体的な課題:
- **リポジトリ層**: `get_by_agent_id`が`maybe_single()`を使用し、単一結果のみを返す
- **API層**: `GET /agents/{agent_id}/recurring-meeting`が`RecurringMeetingResponse | None`を返す（単数形）
- **フロントエンド**: 単一選択UIで実装されている

ユーザーは複数の定例MTGを1つのエージェントに紐付け、それらの議事録やSlack履歴を横断的に集約したアジェンダを生成したいというニーズがある。例えば、プロジェクトXに関連する「週次進捗MTG」と「隔週レビューMTG」の両方の文脈を統合したアジェンダ生成が可能になる。

## 決定事項

1エージェントに対して複数の定例MTGを紐付け可能とするため、アプリケーション層を1対多に対応させる。

### 決定の詳細

| 項目 | 内容 |
|-----|-----|
| **決定** | リポジトリ・API・UIすべてを1対多対応に変更する |
| **なぜ今か** | DBスキーマは既に1対多対応済みであり、アプリケーション層の修正のみで実現可能。複数定例からの横断的アジェンダ生成はコア価値の一つ |
| **なぜこれか** | v2 API追加は複雑性が増し、フロントエンドも同時更新するため直接変更が適切 |
| **既知の不確実性** | 複数定例からの情報統合時のプロンプト設計（どのように文脈を統合するか） |
| **撤回基準** | 複数定例の統合がユーザーにとって複雑すぎると判明した場合 |

## 根拠

DBスキーマが既に1対多をサポートしており、アプリケーション層の変更のみで実現可能であるため、技術的リスクが低い。また、複数定例からの横断的な情報収集・アジェンダ生成は本プロダクトのコア価値の一つであり、早期に対応することで価値検証が可能になる。

### 検討した選択肢

1. **選択肢1: v2 API追加**
   - メリット:
     - 既存クライアントへの影響がない
     - 段階的移行が可能
   - デメリット:
     - API管理の複雑性が増加
     - 同一機能に2つのエンドポイントが存在する期間が発生
     - フロントエンドも同時更新するため実質的なメリットが薄い

2. **選択肢2: 中間テーブル追加（agent_recurring_meetings）**
   - メリット:
     - 紐付けに追加メタデータ（優先度、有効/無効フラグ等）を付与可能
     - 多対多への拡張も容易
   - デメリット:
     - DBスキーマ変更が必要
     - 現在のスキーマで十分対応可能（agent_idがFKとして設計済み）
     - 追加の複雑性に見合う要件が現時点では存在しない

3. **選択肢3（採用）: v1 APIを直接変更**
   - メリット:
     - シンプルな実装
     - DBスキーマ変更不要
     - フロントエンドと同時更新のため整合性が保たれる
     - コードベースの一貫性を維持
   - デメリット:
     - 破壊的変更（既存のAPI契約が変更される）
     - 既存テストの修正が必要

## 影響

### ポジティブな影響

- **柔軟な定例MTG管理**: 1エージェントに複数の関連定例を紐付けて管理可能
- **横断的アジェンダ生成**: 複数定例の議事録・Slack履歴を統合したアジェンダ生成が可能
- **UX向上**: 関連する複数定例をまとめて扱えることでユーザー体験が向上
- **将来の拡張性**: 複数定例からの情報統合ロジックを追加する基盤が整備される

### ネガティブな影響

- **破壊的API変更**: `GET /agents/{agent_id}/recurring-meeting`のレスポンス型が変更
  - 単数: `RecurringMeetingResponse | None`
  - 複数: `list[RecurringMeetingResponse]`
- **テスト修正**: 既存のユニットテスト・統合テストの修正が必要
- **UIの再設計**: フロントエンドUIを一覧表示 + 追加ボタン形式に変更

### 中立的な影響

- **エンドポイント名変更**: 複数形に変更（`/recurring-meeting` → `/recurring-meetings`）
- **リポジトリメソッド変更**: `get_by_agent_id`の戻り値型変更

## 実装指針

### リポジトリ層の変更方針

- `get_by_agent_id`の戻り値を`list[RecurringMeeting]`に変更
- `maybe_single()`を削除し、複数結果を返すクエリに変更
- 関連するインターフェース定義も同様に変更

### API層の変更方針

- エンドポイントパスを複数形に変更（`/recurring-meetings`）
- レスポンス型を`list[RecurringMeetingResponse]`に変更
- 紐付けAPI（PATCH）は複数回呼び出しで追加する設計を維持
- 解除API（DELETE）は`recurring_meeting_id`をパスパラメータとして受け取る形式に変更

### フロントエンド層の変更方針

- 一覧表示 + 追加ボタンのUI設計を採用
- 既存の`RecurringMeetingSelector`を複数選択対応に拡張
- 紐付け済み定例の一覧表示と個別解除機能を追加

### 複数定例情報統合の方針

- アジェンダ生成時に紐付けられた全定例の議事録・Slack履歴を収集
- 時系列順にソートして文脈を構築
- プロンプトで「複数の定例MTGからの情報」であることを明示

## 関連情報

- [ADR-0001: クリーンアーキテクチャ採用](./ADR-0001-clean-architecture-adoption.md)
- [ADR-0004: RLSベースの認可アーキテクチャ](./ADR-0004-rls-based-authorization.md)
- DBスキーマ: `supabase/migrations/20260201180000_create_recurring_meetings.sql`
