# Claude Code é–‹ç™ºãƒ«ãƒ¼ãƒ«

AIå®Ÿè¡Œç²¾åº¦æœ€å¤§åŒ–ã®ãŸã‚ã®ä¸­æ ¸ãƒ«ãƒ¼ãƒ«ã€‚å…¨ã¦ã®æŒ‡ç¤ºã¯ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«å¾“ã†ã€‚

## ğŸš¨ æœ€é‡è¦åŸå‰‡ï¼šèª¿æŸ»OKã€å®Ÿè£…STOP

**ã™ã¹ã¦ã®Edit/Write/MultiEditãƒ„ãƒ¼ãƒ«ä½¿ç”¨å‰ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èªãŒå¿…é ˆ**

ç†ç”±ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ„å›³ã¨ç•°ãªã‚‹å®Ÿè£…ã‚’é˜²ãã€æ­£ã—ã„æ–¹å‘æ€§ã‚’ç¢ºä¿ã™ã‚‹ãŸã‚

## å¿…é ˆå®Ÿè¡Œãƒ—ãƒ­ã‚»ã‚¹

### å®Ÿè¡Œãƒ•ãƒ­ãƒ¼ï¼ˆå¿…é ˆæ‰‹é †ï¼‰
1. **TodoWriteã§ã‚¿ã‚¹ã‚¯åˆ†è§£** â†’ ãªã‘ã‚Œã°å®Ÿè£…ã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã‚ãªã„
   ç†ç”±ï¼šã‚¿ã‚¹ã‚¯ã‚’æ§‹é€ åŒ–ã—ã€é€²æ—ã‚’è¿½è·¡å¯èƒ½ã«ã™ã‚‹ãŸã‚
2. **rule-advisorå®Ÿè¡Œ** â†’ ã‚¿ã‚¹ã‚¯ã®æœ¬è³ªã‚’ç†è§£ã—é©åˆ‡ãªãƒ«ãƒ¼ãƒ«ã‚’é¸æŠ
   ç†ç”±ï¼šé©åˆ‡ãªãƒ«ãƒ¼ãƒ«ã‚’é¸æŠã—ã€ã‚¿ã‚¹ã‚¯ã®æœ¬è³ªã‚’ç†è§£ã™ã‚‹ãŸã‚
3. **Edit/Write/MultiEditä½¿ç”¨** â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èªãŒå¿…é ˆ
   ç†ç”±ï¼šæœ€é‡è¦åŸå‰‡ã®å®Ÿè·µï¼ˆèª¿æŸ»OKã€å®Ÿè£…STOPï¼‰
4. **å®Ÿè£…å®Ÿè¡Œ** â†’ å“è³ªãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼ã¯å®Œäº†æ¡ä»¶ã‚’æº€ãŸã•ãªã„
   ç†ç”±ï¼šé«˜å“è³ªãªã‚³ãƒ¼ãƒ‰ã‚’ä¿è¨¼ã™ã‚‹ãŸã‚
5. **ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã‚«ã‚¦ãƒ³ãƒˆ** â†’ é–¾å€¤è¶…éã§è‡ªå‹•åœæ­¢
   ç†ç”±ï¼šå½±éŸ¿ç¯„å›²ãŒå¤§ãããªã‚‹å‰ã«ç¢ºèªã‚’å–ã‚‹ãŸã‚

### TodoWriteã¨ãƒ¡ã‚¿èªçŸ¥ã®çµ±åˆ
**å®Ÿè¡Œãƒ«ãƒ¼ãƒ«**ï¼š
- `pending â†’ in_progress`æ™‚: rule-advisorã®å‡ºåŠ›ãŒå¿…é ˆ
- **rule-advisorå®Ÿè¡Œå¾Œ**: å¿…ãšTodoWriteã‚’ä»¥ä¸‹ã®å½¢å¼ã§æ›´æ–°
  1. metaCognitiveGuidance.firstStepã‚’Todoã®å…ˆé ­ã‚¿ã‚¹ã‚¯ã¨ã—ã¦è¿½åŠ 
  2. metaCognitiveGuidance.taskEssenceã‚’å„ã‚¿ã‚¹ã‚¯ã®å®Œäº†åˆ¤æ–­åŸºæº–ã¨ã—ã¦è¨˜éŒ²
  3. warningPatternsã‚’å®Ÿè¡Œä¸­ã®ç¢ºèªé …ç›®ã¨ã—ã¦è¨˜éŒ²
- TodoWriteãªã—ã§Editãƒ„ãƒ¼ãƒ«ä½¿ç”¨: ãƒ«ãƒ¼ãƒ«é•åã¨ã—ã¦åœæ­¢
- å„ã‚¿ã‚¹ã‚¯ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°æ™‚: å®Ÿæ–½å†…å®¹ã®è¨˜éŒ²ã‚’å¿…é ˆåŒ–ï¼ˆç©ºç™½ä¸å¯ï¼‰

### å®Ÿè¡Œå‰ææ¡ä»¶
1. **rule-advisorã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®Ÿè¡Œ(Taskãƒ„ãƒ¼ãƒ«ã§å‘¼ã³å‡ºã™ã“ã¨)** â†’ JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒå­˜åœ¨ã™ã‚‹ã“ã¨
2. **TodoWriteã®ã‚¿ã‚¹ã‚¯** â†’ in_progressã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒå­˜åœ¨ã™ã‚‹ã“ã¨
3. **ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èªè¨˜éŒ²** â†’ Edit/Writeå‰ã«æ˜ç¤ºçš„æ‰¿èªãŒã‚ã‚‹ã“ã¨
4. **å“è³ªãƒã‚§ãƒƒã‚¯çµæœ** â†’ ã‚¨ãƒ©ãƒ¼0ã§ãªã‘ã‚Œã°å®Œäº†ä¸å¯

### å¿…é ˆã®ä»£æ›¿ãƒ‘ã‚¿ãƒ¼ãƒ³
- **anyå‹ã®ä»£ã‚ã‚Š** â†’ unknownå‹ã¨å‹ã‚¬ãƒ¼ãƒ‰ã‚’ä½¿ç”¨
  ç†ç”±ï¼šå‹å®‰å…¨æ€§ã‚’ç¢ºä¿ã—ã€å®Ÿè¡Œæ™‚ã‚¨ãƒ©ãƒ¼ã‚’é˜²æ­¢ã™ã‚‹ãŸã‚
- **Editä½¿ç”¨æ™‚** â†’ å¿…ãšTodoWriteã§ã‚¿ã‚¹ã‚¯ç®¡ç†ã‚’å…ˆè¡Œ
  ç†ç”±ï¼šé€²æ—è¿½è·¡ã¨å“è³ªä¿è¨¼ã‚’å¯èƒ½ã«ã™ã‚‹ãŸã‚
- **Edit/Write/MultiEditä½¿ç”¨æ™‚** â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èªã‚’å–å¾—ã—ã¦ã‹ã‚‰å®Ÿè¡Œ
  ç†ç”±ï¼šæœ€é‡è¦åŸå‰‡ï¼ˆèª¿æŸ»OKã€å®Ÿè£…STOPï¼‰ã‚’éµå®ˆã™ã‚‹ãŸã‚
- **å®Œäº†å®£è¨€æ™‚** â†’ å“è³ªãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼0ã‚’ç¢ºèªã—ã¦ã‹ã‚‰å®£è¨€
  ç†ç”±ï¼šå®Œå…¨ãªã‚³ãƒ¼ãƒ‰ã®ã¿ã‚’ãƒãƒ¼ã‚¸ã™ã‚‹ãŸã‚

## ãƒ¡ã‚¿èªçŸ¥å®Ÿè¡Œï¼ˆã‚¿ã‚¹ã‚¯é–‹å§‹æ™‚å¿…é ˆï¼‰

### rule-advisorã‹ã‚‰å–å¾—ã—ãŸæƒ…å ±ã§ãƒ¡ã‚¿èªçŸ¥
1. **taskEssenceï¼ˆã‚¿ã‚¹ã‚¯ã®æœ¬è³ªï¼‰ã‚’ç†è§£**
   - è¡¨é¢çš„ãªä½œæ¥­å†…å®¹ã¨æ ¹æœ¬ç›®çš„ã®åŒºåˆ¥
   - ã€Œquick fixã€vsã€Œproper solutionã€ã®åˆ¤å®š

2. **selectedSkillsï¼ˆé©ç”¨ã‚¹ã‚­ãƒ«ï¼‰ã‚’ç¢ºèª**
   - é¸æŠã•ã‚ŒãŸã‚¹ã‚­ãƒ«ãŒé©åˆ‡ã‹åˆ¤æ–­
   - å¿…è¦ãªã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’èª­ã¿è¾¼ã‚€

3. **metaCognitiveGuidance.pastFailuresï¼ˆéå»ã®å¤±æ•—ï¼‰ã‚’èªè­˜**
   - åŒã˜å¤±æ•—ã‚’ç¹°ã‚Šè¿”ã•ãªã„ã‚ˆã†æ³¨æ„
   - æç¤ºã•ã‚ŒãŸå›é¿ç­–ã‚’æ„è­˜

4. **metaCognitiveGuidance.firstStepï¼ˆåˆå‹•ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰ã‚’å®Ÿè¡Œ**
   - æ¨å¥¨ã•ã‚ŒãŸãƒ„ãƒ¼ãƒ«ã‹ã‚‰é–‹å§‹
   - è¨ˆç”»çš„ã«é€²ã‚ã‚‹

## Claudeè¡Œå‹•åˆ¶å¾¡ï¼ˆå¤±æ•—é˜²æ­¢ï¼‰

### è‡ªå‹•åœæ­¢ãƒˆãƒªã‚¬ãƒ¼ï¼ˆå¿…ãšåœæ­¢ï¼‰
- **5ãƒ•ã‚¡ã‚¤ãƒ«ä»¥ä¸Šã®å¤‰æ›´æ¤œå‡º**ï¼šå³åº§åœæ­¢ã€å½±éŸ¿ç¯„å›²ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å ±å‘Š
  ç†ç”±ï¼šå¤§è¦æ¨¡å¤‰æ›´ã¯äº‹å‰è¨ˆç”»ã¨ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå¿…è¦ãªãŸã‚
- **åŒã˜ã‚¨ãƒ©ãƒ¼3å›ç™ºç”Ÿ**ï¼šæ ¹æœ¬åŸå› åˆ†æå¿…é ˆ
  ç†ç”±ï¼šå¯¾ç—‡ç™‚æ³•ã§ã¯ãªãæ ¹æœ¬è§£æ±ºãŒå¿…è¦ãªãŸã‚
- **unknownå‹å¤šç”¨æ¤œå‡º**ï¼šå‹ã‚¬ãƒ¼ãƒ‰è¨­è¨ˆå†æ¤œè¨
  ç†ç”±ï¼šå‹å®‰å…¨æ€§ã®è¨­è¨ˆã«å•é¡ŒãŒã‚ã‚‹å¯èƒ½æ€§ãŒé«˜ã„ãŸã‚
- **3ãƒ•ã‚¡ã‚¤ãƒ«ç·¨é›†å®Œäº†**: TodoWriteã®æ›´æ–°ã‚’å¼·åˆ¶ï¼ˆæ›´æ–°ã—ãªã„ã¨æ¬¡ã®Editãƒ„ãƒ¼ãƒ«ä½¿ç”¨ä¸å¯ï¼‰
  ç†ç”±ï¼šé€²æ—ç¢ºèªã¨æ–¹å‘æ€§ã®å†ç¢ºèªãŒå¿…è¦ãªãŸã‚

### ã‚¨ãƒ©ãƒ¼ä¿®æ­£è¡å‹•å¯¾å‡¦
1. ã‚¨ãƒ©ãƒ¼ç™ºè¦‹ â†’ **ä¸€æ™‚åœæ­¢**
2. rule-advisorå†å®Ÿè¡Œ
3. æ ¹æœ¬åŸå› åˆ†æï¼ˆãªãœï¼Ÿã‚’5å›ç¹°ã‚Šè¿”ã—ã¦çœŸå› ã‚’ç‰¹å®šï¼‰
4. å¯¾å‡¦è¨ˆç”»æç¤º
5. ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èªå¾Œã«ä¿®æ­£

### ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åŸºæº–ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèªå¿…é ˆï¼‰
- ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å¤‰æ›´ï¼ˆæ–°ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ ã€è²¬å‹™å¤‰æ›´ï¼‰
- å¤–éƒ¨ä¾å­˜è¿½åŠ ï¼ˆnpmãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã€å¤–éƒ¨APIï¼‰
- ç ´å£Šçš„å¤‰æ›´ï¼ˆæ—¢å­˜APIã®å¤‰æ›´ã€ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®å¤‰æ›´ï¼‰
- è¤‡æ•°ã®å®Ÿè£…æ–¹æ³•ãŒã‚ã‚Šå„ªåŠ£ãŒåˆ¤æ–­ã§ããªã„å ´åˆ

### é›†ä¸­æ™‚ã®ãƒ«ãƒ¼ãƒ«ç„¡è¦–é˜²æ­¢
**æ¸¬å®šå¯èƒ½ãªå¼·åˆ¶åœæ­¢åŸºæº–**ï¼š
- **é€£ç¶šã‚¨ãƒ©ãƒ¼ä¿®æ­£2å›ç›®**: è‡ªå‹•çš„ã«rule-advisorå†å®Ÿè¡Œã‚’ãƒˆãƒªã‚¬ãƒ¼
- **Editãƒ„ãƒ¼ãƒ«5å›ä½¿ç”¨**: å½±éŸ¿ç¯„å›²ãƒ¬ãƒãƒ¼ãƒˆã®ä½œæˆã‚’å¼·åˆ¶
- **åŒä¸€ãƒ•ã‚¡ã‚¤ãƒ«3å›ç·¨é›†**: ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°æ¤œè¨ã®å¼·åˆ¶åœæ­¢

### ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆãƒ«ãƒ¼ãƒ«
ä½œæ¥­ä¸­ãƒ•ã‚¡ã‚¤ãƒ«ã¯`tmp/`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½¿ç”¨ã€‚å®Œäº†æ™‚å‰Šé™¤ã€‚

## ğŸ” RLSï¼ˆRow Level Securityï¼‰å®Ÿè£…æ–¹é‡

### åŸºæœ¬åŸå‰‡: Defense in Depthï¼ˆå¤šå±¤é˜²å¾¡ï¼‰

```
èªå¯ã¯å¿…ãš2å±¤ã§å®Ÿæ–½ã™ã‚‹:
1. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤: user_idãƒ•ã‚£ãƒ«ã‚¿ï¼ˆæ˜ç¤ºçš„ï¼‰
2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å±¤: RLSãƒãƒªã‚·ãƒ¼ï¼ˆæš—é»™çš„ãƒ»æœ€çµ‚é˜²è¡›ç·šï¼‰
```

**ç†ç”±**: ç‰‡æ–¹ã«å®Ÿè£…æ¼ã‚ŒãŒã‚ã£ã¦ã‚‚ã€ã‚‚ã†ç‰‡æ–¹ã§é˜²å¾¡ã§ãã‚‹

---

### å¿…é ˆå®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³

#### 1. Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ä½¿ã„åˆ†ã‘

| ç”¨é€” | ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ | RLS | ä½¿ç”¨å ´é¢ |
|------|-------------|-----|---------|
| é€šå¸¸API | `get_user_supabase_client` | âœ… é©ç”¨ | èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ“ä½œ |
| OAuth callback | `get_supabase_client` | âŒ ãƒã‚¤ãƒ‘ã‚¹ | å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ |
| ãƒãƒƒãƒå‡¦ç† | `get_supabase_client` | âŒ ãƒã‚¤ãƒ‘ã‚¹ | ç®¡ç†ã‚¿ã‚¹ã‚¯ã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ |

```python
# âœ… æ­£ã—ã„: èªè¨¼æ¸ˆã¿APIã§ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä»˜ãã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
def get_repository(
    client: Client = Depends(get_user_supabase_client),
) -> AgentRepositoryImpl:
    return AgentRepositoryImpl(client)

# âœ… æ­£ã—ã„: OAuth callbackã¯service_roleã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
def get_callback_repository() -> SlackIntegrationRepositoryImpl:
    client = get_supabase_client()  # service_role
    return SlackIntegrationRepositoryImpl(client)
```

#### 2. å…¨CRUDæ“ä½œã§ã®user_idãƒ•ã‚£ãƒ«ã‚¿ï¼ˆå¿…é ˆï¼‰

```python
# âœ… æ­£ã—ã„: å…¨æ“ä½œã§user_idãƒ•ã‚£ãƒ«ã‚¿ã‚’æ˜ç¤º
def get_by_id(self, id: UUID, user_id: UUID):
    return self.client.table("items").select("*").eq("id", str(id)).eq("user_id", str(user_id)).execute()

def update(self, item: Item):
    return self.client.table("items").update(data).eq("id", str(item.id)).eq("user_id", str(item.user_id)).execute()

def delete(self, id: UUID, user_id: UUID):
    return self.client.table("items").delete().eq("id", str(id)).eq("user_id", str(user_id)).execute()
```

#### 3. ãƒªãƒã‚¸ãƒˆãƒªã®DIãƒ‘ã‚¿ãƒ¼ãƒ³

```python
# âœ… æ­£ã—ã„: ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§Clientã‚’å—ã‘å–ã‚‹
class MyRepositoryImpl:
    def __init__(self, client: Client) -> None:
        self._client = client

# âŒ ç¦æ­¢: å†…éƒ¨ã§ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã‚’å‘¼ã³å‡ºã™
class MyRepositoryImpl:
    def __init__(self) -> None:
        self._client = get_supabase_client()  # RLSãƒã‚¤ãƒ‘ã‚¹ã®ãƒªã‚¹ã‚¯
```

---

### ç¦æ­¢ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰

#### âŒ 1. UPDATE/DELETEã§user_idãƒ•ã‚£ãƒ«ã‚¿ãªã—

```python
# âŒ å±é™º: ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°å¯èƒ½
self.client.table("items").update(data).eq("id", str(id)).execute()

# âœ… å®‰å…¨: user_idã§ãƒ•ã‚£ãƒ«ã‚¿
self.client.table("items").update(data).eq("id", str(id)).eq("user_id", str(user_id)).execute()
```

#### âŒ 2. service_roleã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’èªè¨¼æ¸ˆã¿APIã§ä½¿ç”¨

```python
# âŒ å±é™º: RLSãŒãƒã‚¤ãƒ‘ã‚¹ã•ã‚Œã‚‹
def get_repository() -> MyRepositoryImpl:
    return MyRepositoryImpl(get_supabase_client())  # service_role

# âœ… å®‰å…¨: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä»˜ãã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
def get_repository(client: Client = Depends(get_user_supabase_client)) -> MyRepositoryImpl:
    return MyRepositoryImpl(client)
```

#### âŒ 3. ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®user_idã‚’ä¿¡é ¼ã™ã‚‹

```python
# âŒ å±é™º: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰æ¸¡ã•ã‚ŒãŸuser_idã‚’ä¿¡é ¼
def create(self, item: Item):
    # item.user_idãŒæ”¹ã–ã‚“ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§
    self.client.table("items").insert({"user_id": str(item.user_id), ...}).execute()

# âœ… å®‰å…¨: èªè¨¼æ¸ˆã¿user_idã‚’ä½¿ç”¨
def create(self, item: Item, authenticated_user_id: UUID):
    self.client.table("items").insert({"user_id": str(authenticated_user_id), ...}).execute()
```

---

### ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

æ–°è¦ãƒªãƒã‚¸ãƒˆãƒª/ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä½œæˆæ™‚ã«å¿…ãšç¢ºèª:

- [ ] ãƒªãƒã‚¸ãƒˆãƒªã¯ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§`Client`ã‚’å—ã‘å–ã£ã¦ã„ã‚‹ã‹
- [ ] ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯`get_user_supabase_client`ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‹
- [ ] SELECTæ“ä½œã«`user_id`ãƒ•ã‚£ãƒ«ã‚¿ãŒã‚ã‚‹ã‹
- [ ] UPDATEæ“ä½œã«`user_id`ãƒ•ã‚£ãƒ«ã‚¿ãŒã‚ã‚‹ã‹
- [ ] DELETEæ“ä½œã«`user_id`ãƒ•ã‚£ãƒ«ã‚¿ãŒã‚ã‚‹ã‹
- [ ] INSERTæ“ä½œã§èªè¨¼æ¸ˆã¿`user_id`ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‹
- [ ] OAuth callbackã¯`get_callback_repository`ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‹

---

### ãƒ†ã‚¹ãƒˆè¦ä»¶

#### å¿…é ˆãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

```python
# 1. ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã“ã¨
async def test_cannot_access_other_user_data():
    # user_aã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
    # user_bã§ã‚¢ã‚¯ã‚»ã‚¹è©¦è¡Œ
    # çµæœãŒç©ºã¾ãŸã¯ã‚¨ãƒ©ãƒ¼ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª

# 2. ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã§ããªã„ã“ã¨
async def test_cannot_update_other_user_data():
    # user_aã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
    # user_bã§æ›´æ–°è©¦è¡Œ
    # å½±éŸ¿è¡Œæ•°ãŒ0ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª

# 3. ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã§ããªã„ã“ã¨
async def test_cannot_delete_other_user_data():
    # user_aã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
    # user_bã§å‰Šé™¤è©¦è¡Œ
    # ãƒ‡ãƒ¼ã‚¿ãŒæ®‹ã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
```

---

### é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [ADR-0004: RLSãƒ™ãƒ¼ã‚¹ã®èªå¯ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](docs/adr/ADR-0004-rls-based-authorization.md)
- [Design Doc: RLSèªå¯ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](docs/design/rls-authorization-architecture.md)

---

## æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆbackend/ï¼‰
- **è¨€èª**: Python 3.12+
- **ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯**: FastAPI
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: Supabase (PostgreSQL + Auth + Storage)
- **ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**: Supabase CLI
- **AI**: AWS Bedrock (Claude Haiku 4.5, Titan Embeddings)
- **ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†**: uv

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆfrontend/ï¼‰
- **è¨€èª**: TypeScript
- **ãƒ“ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ«**: Vite
- **UIãƒ©ã‚¤ãƒ–ãƒ©ãƒª**: React 19
- **ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°**: Tailwind CSS v4
- **ãƒ†ã‚¹ãƒˆ**: Vitest + React Testing Library
- **Lint/Format**: Biome
- **ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†**: npm

### ã‚¤ãƒ³ãƒ•ãƒ©
- **ã‚³ãƒ³ãƒ†ãƒŠ**: Docker, Docker Compose

## å“è³ªãƒã‚§ãƒƒã‚¯ã‚³ãƒãƒ³ãƒ‰

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆbackend/ï¼‰
```bash
cd backend
uv run ruff check .       # Lint
uv run ruff format .      # Format
uv run mypy .             # å‹ãƒã‚§ãƒƒã‚¯
uv run pytest             # ãƒ†ã‚¹ãƒˆ
uv run pytest --cov       # ã‚«ãƒãƒ¬ãƒƒã‚¸
```

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆfrontend/ï¼‰
```bash
cd frontend
npm run check             # Biome (lint + format)
npm run type-check        # TypeScriptå‹ãƒã‚§ãƒƒã‚¯
npm run test              # ãƒ†ã‚¹ãƒˆ
npm run test:coverage     # ã‚«ãƒãƒ¬ãƒƒã‚¸
npm run build             # æœ¬ç•ªãƒ“ãƒ«ãƒ‰
```

### é–‹ç™ºç’°å¢ƒï¼ˆMakefileï¼‰
```bash
make dev              # Supabase + App èµ·å‹•
make down             # åœæ­¢
make logs             # ãƒ­ã‚°ç¢ºèª
make supabase-status  # Supabaseã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
```

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ (Supabase CLI)
```bash
make migrate          # æœ¬ç•ªã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨ï¼ˆå·®åˆ†ã®ã¿ï¼‰
make migrate-up       # ãƒ­ãƒ¼ã‚«ãƒ«ã«å·®åˆ†ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨ï¼ˆæ¨å¥¨ï¼‰
make migrate-reset    # ãƒ­ãƒ¼ã‚«ãƒ«DBãƒªã‚»ãƒƒãƒˆï¼ˆâš ï¸ å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ï¼‰
make migrate-new      # æ–°è¦ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆ
make migrate-status   # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ç¢ºèª
```

ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã¯ `supabase/migrations/` ã«é…ç½®:
- ãƒ­ãƒ¼ã‚«ãƒ«: `supabase start` ã§è‡ªå‹•é©ç”¨
- æœ¬ç•ª: `supabase db push` ã§é©ç”¨

### ğŸš¨ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œãƒ«ãƒ¼ãƒ«ï¼ˆå¿…é ˆï¼‰

**é€šå¸¸ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨æ™‚:**
- âœ… `make migrate-up` ã‚’ä½¿ç”¨ï¼ˆå·®åˆ†ã®ã¿é©ç”¨ã€ãƒ‡ãƒ¼ã‚¿ä¿æŒï¼‰
- âŒ `make migrate-reset` ã¯ä½¿ç”¨ç¦æ­¢ï¼ˆå…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã•ã‚Œã‚‹ï¼‰

**migrate-resetã‚’ä½¿ç”¨ã—ã¦ã‚ˆã„å ´åˆï¼ˆé™å®šçš„ï¼‰:**
- åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ™‚
- ã‚¹ã‚­ãƒ¼ãƒã‚’ä¸€ã‹ã‚‰ä½œã‚Šç›´ã™å¿…è¦ãŒã‚ã‚‹æ™‚
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰æ˜ç¤ºçš„ã«æŒ‡ç¤ºã•ã‚ŒãŸæ™‚

**æœ¬ç•ªç’°å¢ƒã§ã®ç¦æ­¢äº‹é …:**
- âŒ `supabase db reset` ã®å®Ÿè¡Œã¯çµ¶å¯¾ç¦æ­¢
- âŒ `make migrate-reset` ã®å®Ÿè¡Œã¯çµ¶å¯¾ç¦æ­¢
- âœ… `make migrate`ï¼ˆ= `supabase db push`ï¼‰ã®ã¿ä½¿ç”¨å¯

### Supabase MCPï¼ˆè£œåŠ©ãƒ„ãƒ¼ãƒ«ï¼‰
- `mcp__supabase__list_tables` - ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§
- `mcp__supabase__execute_sql` - SQLå®Ÿè¡Œ
- `mcp__supabase__get_logs` - ãƒ­ã‚°ç¢ºèª

### Voice Notification Rules

- **å…¨ã¦ã®ã‚¿ã‚¹ã‚¯å®Œäº†æ™‚ã«ã¯å¿…ãšVOICEVOXã®éŸ³å£°é€šçŸ¥æ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨**
- **é‡è¦ãªãŠçŸ¥ã‚‰ã›ã‚„ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã«ã‚‚éŸ³å£°é€šçŸ¥ã‚’è¡Œã†ã“ã¨**
- **éŸ³å£°é€šçŸ¥ã®è¨­å®š: speaker=1, speedScale=1.3ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨**
- **è‹±å˜èªã¯é©åˆ‡ã«ã‚«ã‚¿ã‚«ãƒŠã«å¤‰æ›ã—ã¦VOICEVOXã«é€ä¿¡ã™ã‚‹ã“ã¨**
- **VOICEVOXã«é€ä¿¡ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã¯ä¸è¦ãªã‚¹ãƒšãƒ¼ã‚¹ã‚’å‰Šé™¤ã™ã‚‹ã“ã¨**
- **1å›ã®éŸ³å£°é€šçŸ¥ã¯100æ–‡å­—ä»¥å†…ã§ã‚·ãƒ³ãƒ—ãƒ«ã«è©±ã™ã“ã¨**
- **ä»¥ä¸‹ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ç´°ã‹ãéŸ³å£°é€šçŸ¥ã‚’è¡Œã†ã“ã¨ï¼š**
  - å‘½ä»¤å—é ˜æ™‚: ã€Œäº†è§£ã§ã™ã€ã€Œæ‰¿çŸ¥ã—ã¾ã—ãŸã€
  - ä½œæ¥­é–‹å§‹æ™‚: ã€Œã€œã‚’é–‹å§‹ã—ã¾ã™ã€  
  - ä½œæ¥­ä¸­: ã€Œèª¿æŸ»ä¸­ã§ã™ã€ã€Œä¿®æ­£ä¸­ã§ã™ã€
  - é€²æ—å ±å‘Š: ã€ŒåŠåˆ†å®Œäº†ã§ã™ã€ã€Œã‚‚ã†å°‘ã—ã§ã™ã€
  - å®Œäº†æ™‚: ã€Œå®Œäº†ã§ã™ã€ã€Œä¿®æ­£å®Œäº†ã§ã™ã€
- **è©³ã—ã„æŠ€è¡“çš„èª¬æ˜ã¯éŸ³å£°é€šçŸ¥ã«å«ã‚ãšã€çµæœã®ã¿ã‚’ç°¡æ½”ã«å ±å‘Šã™ã‚‹ã“ã¨**
